generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String                 @id
  email               String?
  name                String?
  imageUrl            String?                @map("image_url")
  createdAt           DateTime?              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime?              @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  preferenceEmbedding Unsupported("vector")? @map("preference_embedding")
  appSettings         AppSettings?
  applications        Application[]
  coverLetters        CoverLetter[]
  linkedInProfiles    LinkedInProfile[]
  resumes             Resume[]
  searchHistory       SearchHistory[]
  userInteractions    UserInteraction[]
  userJobs            UserJob[]

  @@index([email], map: "idx_users_email")
  @@map("users")
}

model Job {
  id                   String            @id @default(uuid()) @db.Uuid
  title                String
  company              String?
  location             String?
  sourceUrl            String            @map("source_url")
  postedAt             DateTime?         @map("posted_at") @db.Timestamptz(6)
  fetchedAt            DateTime?         @default(now()) @map("fetched_at") @db.Timestamptz(6)
  status               String?           @default("fresh")
  archived_at          DateTime?         @db.Timestamptz(6)
  normalizedText       String?           @map("normalized_text")
  rawTextSummary       String?           @map("raw_text_summary")
  contentHash          String?           @unique @map("content_hash")
  createdAt            DateTime?         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime?         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  isImported           Int?              @default(0) @map("is_imported")
  originalPostedDate   String?           @map("original_posted_date")
  originalPostedRaw    String?           @map("original_posted_raw")
  originalPostedSource String?           @map("original_posted_source")
  locationDisplay      String?           @map("location_display")
  importTag            String?           @map("import_tag")
  rawDescriptionHtml   String?           @map("raw_description_html")
  jobDescriptionPlain  String?           @map("job_description_plain")
  datePostedIso        String?           @map("date_posted_iso")
  datePostedDisplay    String?           @map("date_posted_display")
  datePostedRelative   Int?              @default(0) @map("date_posted_relative")
  sourceHost           String?           @map("source_host")
  scrapedAt            DateTime?         @map("scraped_at") @db.Timestamptz(6)
  extractionConfidence Json?             @map("extraction_confidence")
  latitude             Float?
  longitude            Float?
  geoResolved          Boolean           @default(false) @map("geo_resolved")
  geoConfidence        Float?            @map("geo_confidence")
  geoSource            String?           @map("geo_source")
  user_id              String?
  applications         Application[]
  coverLetters         CoverLetter[]
  jobEmbedding         JobEmbedding?
  geoPoints            JobGeoPoint[]
  userInteractions     UserInteraction[]
  userJobs             UserJob[]

  @@index([fetchedAt(sort: Desc)], map: "idx_jobs_fetched_at")
  @@index([contentHash], map: "idx_jobs_content_hash")
  @@index([importTag], map: "idx_jobs_import_tag")
  @@index([status], map: "idx_jobs_status")
  @@index([user_id], map: "idx_jobs_user_id")
  @@map("jobs")
}

model UserJob {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String    @map("user_id")
  jobId          String    @map("job_id") @db.Uuid
  status         String?   @default("fresh")
  matchScore     Float?    @map("match_score")
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  matched_skills Json?
  missing_skills Json?
  why            String?
  archived_at    DateTime? @db.Timestamptz(6)
  updatedAt      DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)
  job            Job       @relation(fields: [jobId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_jobs_job")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_jobs_user")

  @@unique([userId, jobId], map: "uniq_user_job")
  @@map("user_jobs")
}

model Resume {
  id              String           @id @default(uuid()) @db.Uuid
  filename        String
  uploadAt        DateTime?        @default(now()) @map("upload_at") @db.Timestamptz(6)
  parsedJson      Json?            @map("parsed_json")
  isDefault       Boolean?         @default(false) @map("is_default")
  fileData        Bytes?           @map("file_data")
  s3Key           String?          @map("s3_key")
  archivedAt      DateTime?        @map("archived_at") @db.Timestamptz(6)
  createdAt       DateTime?        @default(now()) @map("created_at") @db.Timestamptz(6)
  userId          String           @map("user_id")
  applications    Application[]
  coverLetters    CoverLetter[]
  resumeEmbedding ResumeEmbedding?
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_resumes_user")

  @@index([userId], map: "idx_resumes_user_id")
  @@index([userId, isDefault], map: "idx_resumes_user_default")
  @@map("resumes")
}

model LinkedInProfile {
  id         String    @id @default(uuid()) @db.Uuid
  filename   String
  uploadAt   DateTime? @default(now()) @map("upload_at") @db.Timestamptz(6)
  parsedJson Json?     @map("parsed_json")
  fileData   Bytes?    @map("file_data")
  s3Key      String?   @map("s3_key")
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  userId     String    @map("user_id")
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_linkedin_profiles_user")

  @@index([userId], map: "idx_linkedin_user_id")
  @@map("linkedin_profiles")
}

model CoverLetter {
  id           String        @id @default(uuid()) @db.Uuid
  jobId        String?       @map("job_id") @db.Uuid
  resumeId     String?       @map("resume_id") @db.Uuid
  generatedAt  DateTime?     @default(now()) @map("generated_at") @db.Timestamptz(6)
  contentHtml  String?       @map("content_html")
  contentText  String?       @map("content_text")
  pdfBlobUrl   String?       @map("pdf_blob_url")
  status       String?       @default("generated")
  s3Key        String?       @map("s3_key")
  createdAt    DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  userId       String        @map("user_id")
  applications Application[]
  job          Job?          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  resume       Resume?       @relation(fields: [resumeId], references: [id])
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_cover_letters_user")

  @@index([userId], map: "idx_cover_letters_user_id")
  @@map("cover_letters")
}

model Application {
  id            String       @id @default(uuid()) @db.Uuid
  jobId         String?      @map("job_id") @db.Uuid
  columnName    String?      @default("Applied") @map("column_name")
  appliedAt     DateTime?    @default(now()) @map("applied_at") @db.Timestamptz(6)
  notes         String?
  resumeId      String?      @map("resume_id") @db.Uuid
  coverLetterId String?      @map("cover_letter_id") @db.Uuid
  externalLink  String?      @map("external_link")
  deleted       Boolean?     @default(false)
  createdAt     DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  userId        String       @map("user_id")
  coverLetter   CoverLetter? @relation(fields: [coverLetterId], references: [id])
  job           Job?         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  resume        Resume?      @relation(fields: [resumeId], references: [id])
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_applications_user")

  @@index([userId], map: "idx_applications_user_id")
  @@index([userId, jobId], map: "idx_applications_user_job")
  @@index([columnName], map: "idx_applications_column")
  @@map("applications")
}

model AppSettings {
  id               Int       @id @default(autoincrement())
  freshLimit       Int?      @default(300) @map("fresh_limit")
  lastUpdated      DateTime? @map("last_updated") @db.Timestamptz(6)
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  excludedKeywords Json?     @map("excluded_keywords")
  userId           String    @unique @map("user_id")
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_app_settings_user")

  @@index([userId], map: "idx_app_settings_user_id")
  @@map("app_settings")
}

model playing_with_neon {
  id    Int    @id @default(autoincrement())
  name  String
  value Float? @db.Real
}

model JobEmbedding {
  jobId     String                 @id @map("job_id") @db.Uuid
  embedding Unsupported("vector")?
  createdAt DateTime?              @default(now()) @map("created_at") @db.Timestamptz(6)
  job       Job                    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([embedding])
  @@map("job_embeddings")
}

model ResumeEmbedding {
  resumeId  String                 @id @map("resume_id") @db.Uuid
  embedding Unsupported("vector")?
  createdAt DateTime?              @default(now()) @map("created_at") @db.Timestamptz(6)
  resume    Resume                 @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("resume_embeddings")
}

model UserInteraction {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String    @map("user_id")
  jobId           String    @map("job_id") @db.Uuid
  interactionType String    @map("interaction_type")
  metadata        Json?     @default("{}")
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  job             Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, jobId], map: "idx_user_interactions_user_job")
  @@index([createdAt], map: "idx_user_interactions_created_at")
  @@map("user_interactions")
}

model SearchHistory {
  id        String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String                 @map("user_id")
  queryText String                 @map("query_text")
  embedding Unsupported("vector")?
  createdAt DateTime?              @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)], map: "idx_search_history_user_created")
  @@map("search_history")
}

model JobGeoPoint {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobId         String    @map("job_id") @db.Uuid
  locationLabel String?   @map("location_label")
  latitude      Float
  longitude     Float
  confidence    Float?
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  job           Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId], map: "idx_job_geo_points_job_id")
  @@index([latitude, longitude], map: "idx_job_geo_points_lat_lng")
  @@map("job_geo_points")
}
