generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String                 @id
  email               String?
  name                String?
  imageUrl            String?                @map("image_url")
  createdAt           DateTime?              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime?              @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  preferenceEmbedding Unsupported("vector")? @map("preference_embedding")
  firstName           String?                @map("first_name")
  lastName            String?                @map("last_name")
  appSettings         AppSettings?
  applications        Application[]
  coverLetters        CoverLetter[]
  postedJobs          Job[]
  linkedInProfiles    LinkedInProfile[]
  resumes             Resume[]
  search_analytics    SearchAnalytics[]
  searchHistory       SearchHistory[]
  userInteractions    UserInteraction[]
  userJobs            UserJob[]
  votes               Int                    @default(0)
  castVotes           UserReputationVote[]   @relation("CastVotes")
  receivedVotes       UserReputationVote[]   @relation("ReceivedVotes")

  @@index([email], map: "idx_users_email")
  @@map("users")
}

model UserReputationVote {
  id           String   @id @default(uuid()) @db.Uuid
  voterId      String   @map("voter_id")
  targetUserId String   @map("target_user_id")
  value        Int // 1 for up, -1 for down
  createdAt    DateTime @default(now()) @map("created_at")

  voter      User @relation("CastVotes", fields: [voterId], references: [id], onDelete: Cascade)
  targetUser User @relation("ReceivedVotes", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@unique([voterId, targetUserId], map: "uniq_reputation_vote")
  @@map("user_reputation_votes")
}

model Job {
  id                     String                   @id @default(uuid()) @db.Uuid
  title                  String
  company                String?
  location               String?
  sourceUrl              String                   @map("source_url")
  postedAt               DateTime?                @map("posted_at") @db.Timestamptz(6)
  fetchedAt              DateTime?                @default(now()) @map("fetched_at") @db.Timestamptz(6)
  status                 String?                  @default("fresh")
  archived_at            DateTime?                @db.Timestamptz(6)
  normalizedText         String?                  @map("normalized_text")
  rawTextSummary         String?                  @map("raw_text_summary")
  contentHash            String?                  @unique @map("content_hash")
  createdAt              DateTime?                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime?                @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  isImported             Int?                     @default(0) @map("is_imported")
  originalPostedDate     String?                  @map("original_posted_date")
  originalPostedRaw      String?                  @map("original_posted_raw")
  originalPostedSource   String?                  @map("original_posted_source")
  locationDisplay        String?                  @map("location_display")
  importTag              String?                  @map("import_tag")
  rawDescriptionHtml     String?                  @map("raw_description_html")
  jobDescriptionPlain    String?                  @map("job_description_plain")
  datePostedIso          String?                  @map("date_posted_iso")
  datePostedDisplay      String?                  @map("date_posted_display")
  datePostedRelative     Int?                     @default(0) @map("date_posted_relative")
  sourceHost             String?                  @map("source_host")
  scrapedAt              DateTime?                @map("scraped_at") @db.Timestamptz(6)
  extractionConfidence   Json?                    @map("extraction_confidence")
  latitude               Float?
  longitude              Float?
  geoResolved            Boolean                  @default(false) @map("geo_resolved")
  geoConfidence          Float?                   @map("geo_confidence")
  geoSource              String?                  @map("geo_source")
  user_id                String?
  titleNormalized        String?                  @map("title_normalized")
  companyNormalized      String?                  @map("company_normalized")
  locationNormalized     String?                  @map("location_normalized")
  search_title_tokens    Unsupported("tsvector")?
  search_company_tokens  Unsupported("tsvector")?
  search_location_tokens Unsupported("tsvector")?
  search_content         Unsupported("tsvector")?
  searchBoostScore       Float?                   @default(1.0) @map("search_boost_score")
  commonTitleCategory    String?                  @map("common_title_category")
  postedByUserId         String?                  @map("posted_by_user_id")
  applications           Application[]
  coverLetters           CoverLetter[]
  jobEmbedding           JobEmbedding?
  geoPoints              JobGeoPoint[]
  postedBy               User?                    @relation(fields: [postedByUserId], references: [id], onUpdate: NoAction, map: "fk_jobs_posted_by_user")
  searchAnalytics        SearchAnalytics[]
  userInteractions       UserInteraction[]
  userJobs               UserJob[]

  @@index([fetchedAt(sort: Desc)], map: "idx_jobs_fetched_at")
  @@index([contentHash], map: "idx_jobs_content_hash")
  @@index([importTag], map: "idx_jobs_import_tag")
  @@index([status], map: "idx_jobs_status")
  @@index([user_id], map: "idx_jobs_user_id")
  @@index([postedByUserId], map: "idx_jobs_posted_by_user_id")
  @@index([titleNormalized], map: "idx_jobs_title_normalized")
  @@index([companyNormalized], map: "idx_jobs_company_normalized")
  @@index([locationNormalized], map: "idx_jobs_location_normalized")
  @@index([company(ops: raw("gin_trgm_ops"))], map: "idx_jobs_company_trgm", type: Gin)
  @@index([location(ops: raw("gin_trgm_ops"))], map: "idx_jobs_location_trgm", type: Gin)
  @@index([search_company_tokens], map: "idx_jobs_search_company", type: Gin)
  @@index([search_content], map: "idx_jobs_search_content", type: Gin)
  @@index([search_location_tokens], map: "idx_jobs_search_location", type: Gin)
  @@index([search_title_tokens], map: "idx_jobs_search_title", type: Gin)
  @@index([title(ops: raw("gin_trgm_ops"))], map: "idx_jobs_title_trgm", type: Gin)
  @@map("jobs")
}

model UserJob {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String    @map("user_id")
  jobId          String    @map("job_id") @db.Uuid
  status         String?   @default("fresh")
  matchScore     Float?    @map("match_score")
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  matched_skills Json?
  missing_skills Json?
  why            String?
  archived_at    DateTime? @db.Timestamptz(6)
  updatedAt      DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)
  upvotes        Int?      @default(0)
  downvotes      Int?      @default(0)
  posterFirstName String?  @map("poster_first_name")
  posterLastName  String?  @map("poster_last_name")
  posterImageUrl  String?  @map("poster_image_url")
  job            Job       @relation(fields: [jobId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_jobs_job")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_jobs_user")

  @@unique([userId, jobId], map: "uniq_user_job")
  @@map("user_jobs")
}

model Resume {
  id              String           @id @default(uuid()) @db.Uuid
  filename        String
  uploadAt        DateTime?        @default(now()) @map("upload_at") @db.Timestamptz(6)
  parsedJson      Json?            @map("parsed_json")
  isDefault       Boolean?         @default(false) @map("is_default")
  fileData        Bytes?           @map("file_data")
  s3Key           String?          @map("s3_key")
  createdAt       DateTime?        @default(now()) @map("created_at") @db.Timestamptz(6)
  userId          String           @map("user_id")
  archivedAt      DateTime?        @map("archived_at") @db.Timestamptz(6)
  applications    Application[]
  coverLetters    CoverLetter[]
  resumeEmbedding ResumeEmbedding?
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_resumes_user")

  @@index([userId], map: "idx_resumes_user_id")
  @@index([userId, isDefault], map: "idx_resumes_user_default")
  @@map("resumes")
}

model LinkedInProfile {
  id         String    @id @default(uuid()) @db.Uuid
  filename   String
  uploadAt   DateTime? @default(now()) @map("upload_at") @db.Timestamptz(6)
  parsedJson Json?     @map("parsed_json")
  fileData   Bytes?    @map("file_data")
  s3Key      String?   @map("s3_key")
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  userId     String    @map("user_id")
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_linkedin_profiles_user")

  @@index([userId], map: "idx_linkedin_user_id")
  @@map("linkedin_profiles")
}

model CoverLetter {
  id           String        @id @default(uuid()) @db.Uuid
  jobId        String?       @map("job_id") @db.Uuid
  resumeId     String?       @map("resume_id") @db.Uuid
  generatedAt  DateTime?     @default(now()) @map("generated_at") @db.Timestamptz(6)
  contentHtml  String?       @map("content_html")
  contentText  String?       @map("content_text")
  pdfBlobUrl   String?       @map("pdf_blob_url")
  status       String?       @default("generated")
  s3Key        String?       @map("s3_key")
  createdAt    DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  userId       String        @map("user_id")
  applications Application[]
  job          Job?          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  resume       Resume?       @relation(fields: [resumeId], references: [id])
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_cover_letters_user")

  @@index([userId], map: "idx_cover_letters_user_id")
  @@map("cover_letters")
}

model Application {
  id            String       @id @default(uuid()) @db.Uuid
  jobId         String?      @map("job_id") @db.Uuid
  columnName    String?      @default("Applied") @map("column_name")
  appliedAt     DateTime?    @default(now()) @map("applied_at") @db.Timestamptz(6)
  notes         String?
  resumeId      String?      @map("resume_id") @db.Uuid
  coverLetterId String?      @map("cover_letter_id") @db.Uuid
  externalLink  String?      @map("external_link")
  deleted       Boolean?     @default(false)
  createdAt     DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  userId        String       @map("user_id")
  coverLetter   CoverLetter? @relation(fields: [coverLetterId], references: [id])
  job           Job?         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  resume        Resume?      @relation(fields: [resumeId], references: [id])
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_applications_user")

  @@index([userId], map: "idx_applications_user_id")
  @@index([userId, jobId], map: "idx_applications_user_job")
  @@index([columnName], map: "idx_applications_column")
  @@map("applications")
}

model AppSettings {
  id               Int       @id @default(autoincrement())
  freshLimit       Int?      @default(300) @map("fresh_limit")
  lastUpdated      DateTime? @map("last_updated") @db.Timestamptz(6)
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  excludedKeywords Json?     @map("excluded_keywords")
  userId           String    @unique @map("user_id")
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_app_settings_user")

  @@index([userId], map: "idx_app_settings_user_id")
  @@map("app_settings")
}

model Company {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @unique
  domain      String?
  logoUrl     String?   @map("logo_url")
  logoFetched Boolean   @default(false) @map("logo_fetched")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([name], map: "idx_companies_name")
  @@map("companies")
}

model playing_with_neon {
  id    Int    @id @default(autoincrement())
  name  String
  value Float? @db.Real
}

model JobEmbedding {
  jobId     String                 @id @map("job_id") @db.Uuid
  embedding Unsupported("vector")?
  createdAt DateTime?              @default(now()) @map("created_at") @db.Timestamptz(6)
  job       Job                    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([embedding])
  @@map("job_embeddings")
}

model ResumeEmbedding {
  resumeId  String                 @id @map("resume_id") @db.Uuid
  embedding Unsupported("vector")?
  createdAt DateTime?              @default(now()) @map("created_at") @db.Timestamptz(6)
  resume    Resume                 @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("resume_embeddings")
}

model UserInteraction {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String    @map("user_id")
  jobId           String    @map("job_id") @db.Uuid
  interactionType String    @map("interaction_type")
  metadata        Json?     @default("{}")
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  job             Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, jobId], map: "idx_user_interactions_user_job")
  @@index([createdAt], map: "idx_user_interactions_created_at")
  @@map("user_interactions")
}

model SearchHistory {
  id        String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String                 @map("user_id")
  queryText String                 @map("query_text")
  embedding Unsupported("vector")?
  createdAt DateTime?              @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)], map: "idx_search_history_user_created")
  @@map("search_history")
}

model JobGeoPoint {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobId         String    @map("job_id") @db.Uuid
  locationLabel String?   @map("location_label")
  latitude      Float
  longitude     Float
  confidence    Float?
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  job           Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId], map: "idx_job_geo_points_job_id")
  @@index([latitude, longitude], map: "idx_job_geo_points_lat_lng")
  @@map("job_geo_points")
}

model SearchAnalytics {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  queryText        String    @map("query_text")
  queryNormalized  String?   @map("query_normalized")
  resultsCount     Int?      @map("results_count")
  clickedJobId     String?   @map("clicked_job_id") @db.Uuid
  userId           String?   @map("user_id")
  sessionId        String?   @map("session_id")
  searchDurationMs Int?      @map("search_duration_ms")
  filtersUsed      Json?     @map("filters_used")
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  clickedJob       Job?      @relation(fields: [clickedJobId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users            User?     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([queryNormalized], map: "idx_search_analytics_query")
  @@index([createdAt(sort: Desc)], map: "idx_search_analytics_created")
  @@index([userId], map: "idx_search_analytics_user")
  @@index([queryNormalized, createdAt, resultsCount, userId], map: "idx_search_analytics_aggregated")
  @@index([queryNormalized, createdAt(sort: Desc)], map: "idx_search_analytics_query_created")
  @@index([userId, queryNormalized, createdAt(sort: Desc)], map: "idx_search_analytics_user_query")
  @@map("search_analytics")
}

model SearchSuggestions {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  term       String    @unique
  termType   String    @map("term_type")
  frequency  Int?      @default(1)
  lastSeenAt DateTime? @default(now()) @map("last_seen_at") @db.Timestamptz(6)
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([term], map: "idx_search_suggestions_term")
  @@index([termType], map: "idx_search_suggestions_type")
  @@index([frequency(sort: Desc)], map: "idx_search_suggestions_freq")
  @@map("search_suggestions")
}
